name: Full Security CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  security:
    name: Full Security Scan
    runs-on: ubuntu-latest

    permissions:
      security-events: write
      contents: read

    steps:
    # ----------------------------------------------------
    # 1. Checkout FULL git history (required for TruffleHog)
    # ----------------------------------------------------
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # ----------------------------------------------------
    # 2. Setup Python
    # ----------------------------------------------------
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.8"

    # ----------------------------------------------------
    # 3. Python SAST - Bandit (FAIL ONLY ON CRITICAL)
    # ----------------------------------------------------
    - name: Install Bandit
      run: pip install bandit

    - name: Run Bandit (CRITICAL only)
      run: |
        bandit -r . -lll -f sarif -o bandit.sarif

    - name: Upload Bandit results to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: bandit.sarif

    # ----------------------------------------------------
    # 4. Secrets Detection - TruffleHog
    # ----------------------------------------------------
    - name: Run TruffleHog
      uses: trufflesecurity/trufflehog@main
      continue-on-error: true
      with:
        path: .
        base: HEAD~1
        head: HEAD

    # ----------------------------------------------------
    # 5. Dependency & Filesystem Scan - Trivy
    # ----------------------------------------------------
    - name: Run Trivy FS Scan
      uses: aquasecurity/trivy-action@0.24.0
      with:
        scan-type: fs
        scan-ref: .
        format: sarif
        output: trivy.sarif
        severity: CRITICAL

    - name: Upload Trivy results
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: trivy.sarif

    # ----------------------------------------------------
    # 6. Docker Image Scan (Cloud Run Ready)
    # ----------------------------------------------------
    - name: Build Docker Image
      run: docker build -t demo-app:latest .

    - name: Scan Docker Image with Trivy
      uses: aquasecurity/trivy-action@0.24.0
      with:
        image-ref: demo-app:latest
        format: sarif
        output: trivy-image.sarif
        severity: CRITICAL

    - name: Upload Docker Scan Results
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: trivy-image.sarif

    # ----------------------------------------------------
    # 7. Infrastructure as Code - Checkov
    # ----------------------------------------------------
    - name: Run Checkov (Terraform / GCP)
      uses: bridgecrewio/checkov-action@v12
      with:
        framework: terraform
        output_format: sarif
        output_file_path: checkov.sarif

    - name: Upload Checkov results
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: checkov.sarif

    # ----------------------------------------------------
    # 8. SonarCloud (Code Quality + Security)
    # ----------------------------------------------------
    - name: SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@v2
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        args: >
          -Dsonar.projectKey=GuntruTirupathamma_DEMO
          -Dsonar.organization=guntrutirupathamma
          -Dsonar.sources=.







